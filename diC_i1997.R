library(tidyverse)
library("RColorBrewer")
library(reshape2)

#base functions und Tafeln (2021)
#Alter geht von 15 bis 69; x = 1 entspricht dem Alter 15, x = 55 entspricht dem Alter 69.
l_x <- c(1e+05,0,0,0,0,0,0,0) #Aktiven,, Inval 1J-6J, SterbeWS 
#Tafeln
#SterbeWS Aktiver M & W & D (x bzw. y bzw. d)

q_xya <- tibble(alter = 15:70,
               q_x = c(0.000090, 0.000120, 0.000152, 0.000183, 0.000205, 0.000217, 0.000220, 0.000216, 0.000207, 0.000196, 0.000184, 0.000174, 0.000166, 0.000162, 0.000160, 0.000162, 0.000165, 0.000170, 0.000176, 0.000184, 0.000192, 0.000203, 0.000216, 0.000233, 0.000254, 0.000280, 0.000311, 0.000349, 0.000394, 0.000448, 0.000508, 0.000574, 0.000641, 0.000710, 0.000780, 0.000856, 0.000939, 0.001034, 0.001141, 0.001259, 0.001388, 0.001530, 0.001683, 0.001849, 0.002032, 0.002236, 0.002472, 0.002755, 0.003101, 0.003528, 0.004048, 0.004665, 0.005377, 0.006176, 0.007054, 0.007999),
               q_y = c(0.000044,0.000052,0.000060,0.000063,0.000064,0.000064,0.000062,0.000061,0.000059,0.000058,0.000057,0.000057,0.000057,0.000057,0.000058,0.000060,0.000063,0.000068,0.000075,0.000084,0.000095,0.000107,0.000121,0.000136,0.000151,0.000169,0.000188,0.000210,0.000235,0.000263,0.000295,0.000330,0.000368,0.000408,0.000449,0.000492,0.000538,0.000587,0.000639,0.000695,0.000754,0.000818,0.000887,0.000962,0.001045,0.001138,0.001248,0.001378,0.001535,0.001721,0.001939,0.002190,0.002475,0.002797,0.003159,0.003567),
               q_d = (q_x+q_y)/2
               ) 
#InvalWS Aktiver M & W & D (x bzw. y bzw. d) (DAV 1997 I)
i_xy <- tibble(alter = 15:70, 
              i_x = c(0.002622,0.002697,0.002753,0.002788,0.002801,0.002812,0.002781,0.002710,0.002621,0.002534,0.002465,0.002426,0.002418,0.002435,0.002471,0.002516,0.002565,0.002616,0.002671,0.002730,0.002796,0.002874,0.002972,0.003093,0.003237,0.003403,0.003586,0.003787,0.004015,0.004284,0.004609,0.005004,0.005466,0.005988,0.006555,0.007157,0.007795,0.008483,0.009245,0.010106,0.011094,0.012227,0.013529,0.015013,0.016723,0.018696,0.020974,0.023612,0.026676,0.030244,0.034406,0.039276,0.044984,0.051693,0.059594,0.068920),
              i_y = c(0.001476,0.001591,0.001701,0.001801,0.001894,0.001953,0.002058,0.002105,0.002118,0.002117,0.002117,0.002128,0.002157,0.002206,0.002274,0.002359,0.002458,0.002572,0.002701,0.002844,0.002997,0.003158,0.003331,0.003521,0.003737,0.003989,0.004284,0.004631,0.005030,0.005475,0.005953,0.006448,0.006947,0.007439,0.007927,0.008421,0.008941,0.009513,0.010178,0.010983,0.011981,0.013231,0.014792,0.016294,0.018209,0.020467,0.023142,0.026319,0.030106,0.034635,0.040074,0.046627,0.054552,0.064169,0.075878,0.090177),
              i_d = (i_x+i_y)/2
              ) 


#SterbeWS M & W & D (x bzw. y bzw. d) im x-ten Jahr der Invalidisierung (DAV 1997 TI)
q_xyi <- tibble(alter   = 15:70, 
                q_xxi = c(0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.003583,0.004321,0.005064,0.005815,0.006579,0.007355,0.008145,0.008950,0.009770,0.010604,0.011455,0.012318,0.013191,0.014071,0.014958,0.015851,0.016747,0.017644,0.018538,0.019425,0.020301,0.021164,0.022015,0.022854,0.023682,0.024503,0.025322,0.026139,0.026954,0.027766,0.028569,0.029364,0.030148,0.030920,0.031676,0.032417,0.033139,0.033841,0.034520,0.035174),
                q_xm1xi = c(0.000000,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.008383,0.009123,0.009864,0.010609,0.011357,0.012108,0.012865,0.013628,0.014401,0.015187,0.015981,0.016781,0.017585,0.018395,0.019206,0.020008,0.020797,0.021569,0.022321,0.023052,0.023764,0.024464,0.025151,0.025826,0.026493,0.027154,0.027813,0.028471,0.029128,0.029778,0.030423,0.031062,0.031693,0.032316,0.032931,0.033535,0.034127,0.034708,0.035276), 
                q_xm2xi = c(0.000000,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.007581,0.008383,0.009123,0.009864,0.010609,0.011357,0.012108,0.012865,0.013628,0.014401,0.015187,0.015981,0.016781,0.017585,0.018395,0.019206,0.020008,0.020797,0.021569,0.022321,0.023052,0.023764,0.024464,0.025151,0.025826,0.026493,0.027154,0.027813,0.028471,0.029128,0.029778,0.030423,0.031062,0.031693,0.032316,0.032931,0.033535,0.034127,0.034708,0.035276), 
                q_xm3xi = c(0.000000,0.000000,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.004321,0.005064,0.005815,0.006520,0.007039,0.007558,0.008077,0.008595,0.009110,0.009627,0.010150,0.010682,0.011225,0.011782,0.012354,0.012938,0.013528,0.014125,0.014728,0.015331,0.015932,0.016525,0.017107,0.017674,0.018228,0.018775,0.019316,0.019858,0.020401,0.020932,0.021459,0.021978,0.022488,0.022988,0.023477,0.023954,0.024417,0.024866,0.025299),
                q_xm4xi = c(0.000000,0.000000,0.000000,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002943,0.003396,0.003848,0.004298,0.004746,0.005194,0.005639,0.006086,0.006535,0.006990,0.007453,0.007924,0.008404,0.008894,0.009391,0.009893,0.010403,0.010925,0.011464,0.012021,0.012598,0.013192,0.013798,0.014412,0.015028,0.015645,0.016261,0.016876,0.017485,0.018088,0.018682,0.019266,0.019836,0.020390,0.020928,0.021446,0.021942),
                q_xm5xi = c(0.000000,0.000000,0.000000,0.000000,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002488,0.002668,0.002946,0.003223,0.003500,0.003777,0.004057,0.004340,0.004627,0.004918,0.005213,0.005515,0.005825,0.006146,0.006477,0.006819,0.007171,0.007533,0.007905,0.008285,0.008674,0.009069,0.009468,0.009869,0.010271,0.010675,0.011079,0.011483,0.012079,0.012622,0.013126,0.013583,0.013989,0.014338,0.014624,0.014845,0.014996,0.015076), 
                q_xm6xi = q_xm5xi,
                q_xm7xi = q_xm5xi,
                q_xm8xi = q_xm5xi,
                q_xi = q_xm5xi,
                q_yyi = c(0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.003661,0.004046,0.004456,0.004868,0.005283,0.005701,0.006125,0.006554,0.006991,0.007439,0.007901,0.008382,0.008879,0.009386,0.009896,0.010405,0.010907,0.011398,0.011873,0.012328,0.012762,0.013179,0.013584,0.013981,0.014374,0.014765,0.015151,0.015530,0.015902,0.016268,0.016567,0.016666,0.016860,0.016998,0.017117,0.017217,0.017297,0.017356,0.017395,0.017413,0.017411,0.017388),
                q_ym1yi = c(0.000000,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.007558,0.008503,0.009448,0.010393,0.011338,0.012296,0.012636,0.012977,0.013320,0.013665,0.014016,0.014377,0.014751,0.015138,0.015539,0.015957,0.016391,0.016838,0.017293,0.017750,0.018212,0.018680,0.019153,0.019634,0.020130,0.020645,0.021178,0.021722,0.022272,0.022825,0.023379,0.023976,0.024573,0.025183,0.025807,0.026445,0.027096,0.027761,0.028440,0.029133,0.029842),
                q_ym2yi = c(0.000000,0.000000,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.002520,0.003446,0.004373,0.005300,0.006227,0.007155,0.008081,0.009009,0.009935,0.010248,0.010577,0.010927,0.011299,0.011690,0.012097,0.012517,0.012941,0.013361,0.013772,0.014170,0.014546,0.014890,0.015192,0.015447,0.015651,0.015812,0.015946,0.016060,0.016164,0.016265,0.016366,0.016439,0.016565,0.016817,0.016860,0.016998,0.017117,0.017217,0.017297,0.017356,0.017395,0.017413,0.017411,0.017388),
                q_ym3yi = c(0.000000,0.000000,0.000000,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.003661,0.004046,0.004456,0.004868,0.005283,0.005701,0.006125,0.006554,0.006991,0.007439,0.007818,0.008102,0.008383,0.008659,0.008932,0.009203,0.009470,0.009736,0.009999,0.010262,0.010520,0.010776,0.011030,0.011287,0.011548,0.011812,0.012077,0.012339,0.012600,0.012860,0.013119,0.013376,0.013633,0.013888,0.014140,0.014390,0.014637,0.014881,0.015121,0.015357,0.015590,0.015819),
                q_ym4yi = c(0.000000,0.000000,0.000000,0.000000,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.002797,0.003035,0.003281,0.003528,0.003773,0.004018,0.004261,0.004501,0.004736,0.004965,0.005187,0.005402,0.005611,0.005816,0.006016,0.006212,0.006403,0.006588,0.006767,0.006940,0.007103,0.007259,0.007407,0.007551,0.007693,0.007834,0.007973,0.008113,0.008255,0.008398,0.008542,0.008687,0.008829,0.008972,0.009115,0.009258,0.009400,0.009543,0.009996,0.010412,0.010849,0.011308), 
                q_ym5yi = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001675,0.001750,0.001830,0.001918,0.002008,0.002103,0.002207,0.002318,0.002434,0.002551,0.002674,0.002810,0.002962,0.003133,0.003324,0.003531,0.003754,0.003991,0.004236,0.004479,0.004708,0.004915,0.005097,0.005268,0.005450,0.005647,0.005869,0.006112,0.006368,0.006633,0.006904,0.007180,0.007454,0.007783,0.008112,0.008458,0.008821,0.009204,0.009606,0.009996,0.010412,0.010849,0.011308),
                q_ym6yi = q_ym5yi,
                q_ym7yi = q_ym5yi,
                q_ym8yi = q_ym5yi,
                q_yi = q_ym5yi,
                q_ddi   = (q_xxi + q_yyi)/2,
                q_dm1di   = (q_xm1xi + q_ym1yi)/2,
                q_dm2di   = (q_xm2xi + q_ym2yi)/2,
                q_dm3di   = (q_xm3xi + q_ym3yi)/2,
                q_dm4di   = (q_xm4xi + q_ym4yi)/2,
                q_dm5di   = (q_xm5xi + q_ym5yi)/2,
                q_dm6di   = (q_xm6xi + q_ym6yi)/2,
                q_dm7di   = (q_xm7xi + q_ym7yi)/2,
                q_dm8di   = (q_xm8xi + q_ym8yi)/2,
                q_di   = (q_xi + q_yi)/2
                )

#r_xp 6+ Tafel 
 r_xyi <- tibble(alter   = 15:71,
                r_xx = c(0.107562,0.106951,0.106487,0.106170,0.105970,0.106001,0.106098,0.106330,0.106728,0.107278,0.108011,0.108898,0.109935,0.110919,0.111668,0.112723,0.114142,0.114872,0.114858,0.114107,0.112815,0.111058,0.108741,0.105837,0.102488,0.098852,0.095082,0.091374,0.087653,0.083989,0.080361,0.076571,0.072412,0.068095,0.063704,0.059216,0.054590,0.049752,0.044776,0.039982,0.035642,0.031594,0.027656,0.023697,0.019655,0.016397,0.013351,0.010693,0.008423,0.006527,0.004975,0.003730,0.002752,0.001997,0.001426,0.001001,0.000000),
                r_xm1x = c(0.000000,0.106951,0.106487,0.106170,0.105970,0.106001,0.106098,0.106330,0.106728,0.107278,0.108011,0.108898,0.109935,0.110919,0.111668,0.111416,0.109697,0.107705,0.105664,0.103560,0.101479,0.099474,0.097576,0.095663,0.093685,0.091701,0.089392,0.086631,0.083527,0.080192,0.076656,0.072705,0.068555,0.064315,0.059689,0.054768,0.049530,0.044215,0.039025,0.034032,0.029349,0.024952,0.020706,0.016499,0.012275,0.009332,0.006735,0.004708,0.003189,0.002092,0.001330,0.000819,0.000489,0.000282,0.000158,0.000086,0.000000),
                r_xm2x = c(0.000000,0.000000,0.094225,0.093047,0.092020,0.091123,0.090434,0.089793,0.089309,0.089004,0.088847,0.088738,0.088544,0.088102,0.087231,0.085861,0.083990,0.081723,0.079145,0.076188,0.072865,0.069282,0.065582,0.062092,0.058853,0.055730,0.052598,0.049367,0.045864,0.042254,0.038629,0.035106,0.031748,0.028615,0.025803,0.023203,0.020621,0.018062,0.015608,0.013314,0.011172,0.009163,0.007191,0.005232,0.003265,0.002242,0.001366,0.000786,0.000427,0.000220,0.000107,0.000049,0.000021,0.000009,0.000004,0.000001,0.000000),
                r_xm3x = c(0.000000,0.000000,0.000000,0.106170,0.105970,0.106001,0.106098,0.106330,0.106728,0.107278,0.108006,0.107029,0.105421,0.103221,0.100539,0.097374,0.093873,0.090068,0.085954,0.081529,0.076805,0.071790,0.066410,0.060851,0.055400,0.050174,0.045158,0.040406,0.035886,0.031667,0.027922,0.024666,0.021828,0.019262,0.016881,0.014693,0.012662,0.010856,0.009235,0.007711,0.006291,0.004949,0.003692,0.002516,0.001384,0.000897,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_xm4x = c(0.000000,0.000000,0.000000,0.000000,0.105970,0.106001,0.106098,0.106330,0.106728,0.107278,0.108006,0.107029,0.105421,0.103182,0.098919,0.094333,0.089376,0.084039,0.078334,0.072431,0.066494,0.060688,0.055080,0.049778,0.044874,0.040389,0.036330,0.032604,0.029128,0.025885,0.022837,0.019871,0.017119,0.014632,0.012409,0.010481,0.008816,0.007349,0.006134,0.005121,0.004206,0.003405,0.002691,0.002055,0.001384,0.000897,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000), 
                r_xm5x = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.091123,0.090434,0.089793,0.089309,0.089004,0.088847,0.088738,0.084114,0.078949,0.073637,0.068257,0.062860,0.057549,0.052471,0.047720,0.043358,0.039468,0.036085,0.033131,0.030444,0.027897,0.025453,0.023058,0.020728,0.018498,0.016402,0.014399,0.012456,0.010657,0.009014,0.007581,0.006378,0.005427,0.004719,0.004205,0.003789,0.003405,0.002691,0.002055,0.001384,0.000897,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_xm6x = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.088104,0.084833,0.081282,0.077527,0.073464,0.069352,0.065195,0.060939,0.056540,0.052107,0.047806,0.043685,0.039781,0.036136,0.032797,0.029748,0.026979,0.024474,0.022187,0.020076,0.018153,0.016437,0.014931,0.013620,0.012380,0.011218,0.010098,0.009001,0.007983,0.007018,0.006121,0.005285,0.004502,0.003771,0.003098,0.002499,0.001974,0.001518,0.001110,0.000819,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_xm7x = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.049442,0.048753,0.047879,0.046863,0.045556,0.044209,0.042767,0.041175,0.039342,0.037314,0.035158,0.032889,0.030570,0.028278,0.026079,0.023991,0.022007,0.020071,0.018171,0.016376,0.014700,0.013112,0.011677,0.010419,0.009248,0.008133,0.007117,0.006153,0.005264,0.004471,0.003777,0.003204,0.002757,0.002406,0.002146,0.001974,0.001518,0.001110,0.000819,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_xm8x = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.048753,0.047879,0.046863,0.045556,0.044209,0.042767,0.041175,0.037824,0.034020,0.030473,0.027158,0.024080,0.021276,0.018801,0.016707,0.014974,0.013565,0.012435,0.011524,0.010758,0.010050,0.009361,0.008664,0.007939,0.007145,0.006319,0.005504,0.004713,0.003964,0.003277,0.002675,0.002174,0.001765,0.001446,0.001207,0.001028,0.000890,0.000819,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_x = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.035447,0.034142,0.032671,0.031080,0.029310,0.027521,0.025683,0.023797,0.021846,0.019816,0.017760,0.015764,0.013873,0.012080,0.010493,0.009140,0.008034,0.007086,0.006284,0.005574,0.005028,0.004654,0.004348,0.004068,0.003768,0.003491,0.003239,0.002910,0.002512,0.002127,0.001830,0.001582,0.001344,0.001144,0.001015,0.000890,0.000819,0.000491,0.000251,0.000119,0.000053,0.000022,0.000009,0.000003,0.000001,0.000000,0.000000,0.000000),
                r_yy = c(0.095520,0.097501,0.099392,0.101187,0.102943,0.104411,0.105873,0.107284,0.108586,0.109706,0.110538,0.110989,0.110991,0.110537,0.109650,0.108312,0.106577,0.104494,0.102110,0.099515,0.096667,0.093539,0.090222,0.086820,0.083560,0.080553,0.077796,0.075275,0.073007,0.070879,0.068868,0.066899,0.065022,0.063083,0.060902,0.058378,0.055477,0.052182,0.048547,0.044688,0.040735,0.036780,0.033003,0.027965,0.022940,0.018818,0.015085,0.011912,0.009282,0.007149,0.005450,0.004118,0.003087,0.002303,0.001924,0.001596,0.000000), 
                r_ym1y = c(0.000000,0.100698,0.102085,0.103468,0.104867,0.106198,0.107549,0.108930,0.110308,0.111650,0.112925,0.114126,0.115170,0.116012,0.116577,0.116731,0.116400,0.115617,0.114452,0.112970,0.111371,0.109718,0.108027,0.106354,0.104687,0.103103,0.101602,0.100061,0.098336,0.096227,0.093730,0.090850,0.087556,0.083807,0.079502,0.074663,0.069335,0.063603,0.057648,0.051592,0.045470,0.039329,0.033003,0.027965,0.022940,0.018818,0.015085,0.011912,0.009282,0.007149,0.005450,0.004118,0.003087,0.002303,0.001924,0.001596,0.000000), 
                r_ym2y = c(0.000000,0.000000,0.098394,0.095158,0.091932,0.088718,0.085542,0.082375,0.079240,0.076153,0.073115,0.070106,0.067149,0.064282,0.061527,0.058897,0.056383,0.053964,0.051640,0.049442,0.047352,0.045354,0.043402,0.041481,0.039587,0.037732,0.035903,0.034060,0.032208,0.030340,0.028482,0.026587,0.024706,0.022874,0.021149,0.019542,0.018012,0.016566,0.015219,0.013978,0.012815,0.011706,0.010631,0.009583,0.008534,0.007596,0.006701,0.005872,0.005110,0.004416,0.003792,0.003233,0.002738,0.002303,0.001924,0.001596,0.000000), 
                r_ym3y = c(0.000000,0.000000,0.000000,0.101187,0.102943,0.104411,0.098047,0.093519,0.088978,0.084390,0.079718,0.074942,0.070095,0.065250,0.060450,0.055777,0.051281,0.046975,0.042839,0.038904,0.035255,0.031972,0.029084,0.026570,0.024404,0.022579,0.021068,0.019805,0.018701,0.017675,0.016695,0.015731,0.014810,0.013920,0.013080,0.012290,0.011502,0.010701,0.009877,0.009014,0.008096,0.007145,0.006170,0.005197,0.004234,0.003415,0.002678,0.002052,0.001536,0.001123,0.000803,0.000560,0.000382,0.000255,0.000166,0.000105,0.000000),
                r_ym4y = c(0.000000,0.000000,0.000000,0.000000,0.099076,0.094997,0.090771,0.086453,0.081983,0.077518,0.073057,0.068606,0.064159,0.059759,0.055457,0.051270,0.047227,0.043357,0.039673,0.036201,0.032966,0.029965,0.027199,0.024705,0.022503,0.020552,0.018806,0.017226,0.015767,0.014394,0.013122,0.011948,0.010851,0.009819,0.008845,0.007950,0.007141,0.006389,0.005686,0.005029,0.004401,0.003789,0.003181,0.002573,0.001963,0.001511,0.001112,0.000794,0.000550,0.000369,0.000240,0.000152,0.000093,0.000055,0.000032,0.000018,0.000000), 
                r_ym5y = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.077890,0.074408,0.070831,0.067183,0.063497,0.059806,0.056110,0.052448,0.048858,0.045351,0.041972,0.038748,0.035657,0.032692,0.029846,0.027120,0.024510,0.022048,0.019768,0.017681,0.015810,0.014180,0.012776,0.011583,0.010575,0.009725,0.009017,0.008414,0.007878,0.007383,0.006895,0.006398,0.005887,0.005377,0.004878,0.004392,0.003789,0.003181,0.002573,0.001963,0.001511,0.001112,0.000794,0.000550,0.000369,0.000240,0.000152,0.000093,0.000055,0.000032,0.000018,0.000000), 
                r_ym6y = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.038305,0.037037,0.035708,0.034341,0.032898,0.031449,0.029987,0.028510,0.027019,0.025506,0.023970,0.022414,0.020863,0.019338,0.017856,0.016440,0.015111,0.013874,0.012735,0.011695,0.010753,0.009913,0.009176,0.008529,0.007940,0.007380,0.006834,0.006288,0.005748,0.005206,0.004664,0.004123,0.003581,0.003045,0.002524,0.002019,0.001523,0.001033,0.000549,0.000356,0.000190,0.000094,0.000042,0.000018,0.000007,0.000003,0.000001,0.000000,0.000000,0.000000,0.000000), 
                r_ym7y = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.037037,0.035708,0.034341,0.032898,0.031449,0.029987,0.028231,0.026306,0.024429,0.022609,0.020836,0.019130,0.017502,0.015970,0.014541,0.013206,0.011964,0.010817,0.009750,0.008766,0.007879,0.007099,0.006431,0.005873,0.005400,0.005003,0.004667,0.004357,0.004067,0.003791,0.003529,0.003277,0.003045,0.002524,0.002019,0.001523,0.001033,0.000549,0.000356,0.000190,0.000094,0.000042,0.000018,0.000007,0.000003,0.000001,0.000000,0.000000,0.000000,0.000000), 
                r_ym8y = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.033789,0.031994,0.030121,0.028195,0.026238,0.024283,0.022339,0.020429,0.018570,0.016797,0.015129,0.013585,0.012173,0.010904,0.009783,0.008801,0.007936,0.007196,0.006568,0.006039,0.005593,0.005210,0.004867,0.004544,0.004257,0.004018,0.003833,0.003694,0.003596,0.003522,0.003277,0.003045,0.002524,0.002019,0.001523,0.001033,0.000549,0.000356,0.000190,0.000094,0.000042,0.000018,0.000007,0.000003,0.000001,0.000000,0.000000,0.000000,0.000000), 
                r_y = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.014392,0.013866,0.013326,0.012779,0.012213,0.011648,0.011089,0.010530,0.009965,0.009405,0.008850,0.008296,0.007733,0.007151,0.006564,0.005977,0.005396,0.004830,0.004301,0.003818,0.003398,0.003028,0.002706,0.002449,0.002238,0.002082,0.001964,0.001889,0.001830,0.001772,0.001710,0.001624,0.001547,0.001523,0.001033,0.000549,0.000356,0.000190,0.000094,0.000042,0.000018,0.000007,0.000003,0.000001,0.000000,0.000000,0.000000,0.000000),
                r_dd   = (r_xx + r_yy)/2,
                r_dm1d   = (r_xm1x + r_ym1y)/2,
                r_dm2d   = (r_xm2x + r_ym2y)/2,
                r_dm3d   = (r_xm3x + r_ym3y)/2,
                r_dm4d   = (r_xm4x + r_ym4y)/2,
                r_dm5d   = (r_xm5x + r_ym5y)/2,
                r_dm6d   = (r_xm6x + r_ym6y)/2,
                r_dm7d   = (r_xm7x + r_ym7y)/2,
                r_dm8d   = (r_xm8x + r_ym8y)/2,
                r_d   = (r_x + r_y)/2,
                r_xp = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.031893,0.036626,0.040952,0.043383,0.045118,0.046036,0.046331,0.045998,0.045043,0.043493,0.041448,0.036836,0.032564,0.028657,0.025157,0.022110,0.019531,0.017390,0.015629,0.014115,0.012754,0.011512,0.010369,0.009291,0.008352,0.007546,0.006796,0.006039,0.005310,0.004636,0.004027,0.003458,0.002932,0.002487,0.002146,0.001859,0.001599,0.001385,0.001247,0.001245,0.000808,0.000442,0.000225,0.000107,0.000047,0.000020,0.000008,0.000003,0.000001,0.000000,0.000000,0.000000), 
                r_yp = c(0.000000,0.000000,0.000000,0.000000,0.000000,0.025161,0.027257,0.028779,0.029740,0.030138,0.030134,0.029616,0.028655,0.027383,0.025880,0.024298,0.021434,0.018873,0.016652,0.014763,0.013144,0.011727,0.010474,0.009375,0.008356,0.007421,0.006594,0.005897,0.005360,0.004970,0.004633,0.004280,0.003976,0.003703,0.003478,0.003255,0.003065,0.002878,0.002683,0.002472,0.002198,0.001922,0.001698,0.001568,0.001488,0.001360,0.001001,0.000715,0.000495,0.000332,0.000216,0.000137,0.000084,0.000050,0.000029,0.000016,0.000000),
                r_dp = (r_xp + r_yp)/2
                ) #ReaktivWS M & W (x bzw. y) im x-ten Jahr der Invalidisierung (DAV 1997 RI)


#p() berechnet die 1-Schritt-Übergangsmatrix p zum alter x.
p <- function(x, g = "u"){
  if(g == "m"){
    m <- matrix(0, 12, 12)
    m[,1] <- c((1-i_xy$i_x[x]-q_xya$q_x[x]),unlist(r_xyi[x, 2:11], use.names = FALSE),0)
    m[1,2] <- i_xy$i_x[x]
    m[,12] <- c(q_xya$q_x[x], unlist(q_xyi[x, 2:11], use.names = FALSE),1.0000000)
    m[11,11] <- 1 - r_xyi$r_x[x] - m[11,12]
    diag(m[2:10,3:11]) <- 1- m[2:10,1] - m[2:10,12]
    return(m)
    
  } else if (g == "w"){
    m <- matrix(0, 12, 12)
    m[,1] <- c((1-i_xy$i_y[x]-q_xya$q_y[x]),unlist(r_xyi[x, 12:21], use.names = FALSE),0)
    m[1,2] <- i_xy$i_y[x]
    m[,12] <- c(q_xya$q_y[x], unlist(q_xyi[x, 12:21], use.names = FALSE),1.0000000)
    m[11,11] <- 1 - r_xyi$r_y[x] - m[11,12]
    diag(m[2:10,3:11]) <- 1- m[2:10,1] - m[2:10,12]
    return(m)
    } else if(g == "u"){
      m <- matrix(0, 12, 12)
      m[,1] <- c((1-i_xy$i_d[x]-q_xya$q_d[x]),unlist(r_xyi[x, 22:31], use.names = FALSE),0)
      m[1,2] <- i_xy$i_d[x]
      m[,12] <- c(q_xya$q_d[x], unlist(q_xyi[x, 22:31], use.names = FALSE),1.0000000)
      m[11,11] <- 1 - r_xyi$r_d[x] - m[11,12]
      diag(m[2:10,3:11]) <- 1- m[2:10,1] - m[2:10,12]
      return(m)
    } else{
      print("für g muss m, w oder u eingegeben werden") 
    }
}

#6+ Tafel
p6p <- function(x, g = "u"){
  m <- p(x, g)
  m[8:11,1] <- r_xyi$r_dp[x]
  m[8,9] <- 1 - m[8,1] - m[8,12]
  m[9,10] <- 1 - m[8,1] - m[8,12]
  m[10,11] <- 1 - m[8,1] - m[8,12]
  m[11,11] <- 1 - m[8,1] - m[8,12]
  return(m)
}

#Reaktivierung nach 4 Jahren ausgeschlossen
p4 <- function(x, g = "u"){
  m <- p(x, g)
  m[6:11,1] <- 0
  m[6,7] <- 1 - m[6,12]
  m[7,8] <- 1 - m[7,12]
  m[8,9] <- 1 - m[8,12]
  m[9,10] <- 1 - m[9,12]
  m[10,11] <- 1 - m[10,12]
  m[11,11] <- 1 - m[11,12]
  return(m)
}
  
#pm() berechnet die m-Schritt-Übergangsmatrix pm zum alter x(g geschlecht, f funk)
pm <- function(x, m, f = 1, g ="u"){
  if(m == 0){
    a <- diag(12)
    return(a)
  }
  if(f == 1){
    a <- p(x,g)
    for(i in (x+1):(x+m-1)){
      a <- a %*% p(i,g) 
    }
    return(a)
  }else if(f == 2){
    a <- p6p(x,g)
    for(i in (x+1):(x+m-1)){
      a <- a %*% p6p(i,g) 
    }
    return(a)
  }else if(f == 4){
    a <- p4(x,g)
    for(i in (x+1):(x+m-1)){
      a <- a %*% p4(i,g) 
    }
    return(a)
  }else("f = 1 für p, f = 2 für p6p, f = 3 für p4")
}


#hm() berechnet die Populationsentwicklung nach m jahren zum Alter x (g Geschlecht, a)
hm <- function(x, m, a = 1, g="u"){
  mu <- c(1e5, rep(0,11))
  h <- mu
  if (a == 1){
    print("p")
    for(i in 1:m){
      h <- rbind(h, mu%*%pm(x,i,f=1,g))
    }
  } else if (a == 2){
    print("p2")
    for(i in 1:m){
      h <- rbind(h, mu%*%pm(x,i,f=2,g))
    }
  } else if ( a== 4){
    print("p4")
    for(i in 1:m){
      h <- rbind(h, mu%*%pm(x,i,f=4,g))
    }
  } else {
    print("wähle a = 1 für p4, a = 0 für p")
    
  }
  
  return(t(h))
}


###############################################################################################
#Plots
###############################################################################################
#Markov-Prozess p
x <- 1
m <- 54
mk <- NULL
mk2 <- c(1e5,rep(0,11))
pop1 <- hm(1,56,1)
pop2 <- hm(1,56,2)
pop4 <- hm(1,56,4)

pop1_data <- data.frame(t(rbind((1+14):(57+14),pop1[1,],colSums(pop1[2:11,]),pop1[12,])))
pop2_data <- data.frame(t(rbind((1+14):(57+14),pop2[1,],colSums(pop2[2:11,]),pop2[12,])))
pop4_data <- data.frame(t(rbind((1+14):(57+14),pop4[1,],colSums(pop4[2:11,]),pop4[12,])))



gg <- NULL
gg <- ggplot() + geom_line(data = pop1_data, aes(x=X1,y=X3,colour= "Invalide1"), linetype=2, size =1.1)+
  geom_line(data =  pop2_data, aes(x=X1,y=X3,colour= "Invalide2"),linetype=5, size =1) +
  geom_line(data =  pop4_data, aes(x=X1,y=X3,colour= "Invalide4"),linetype=5, size =1) +
  xlab("Alter")+
  ylab("Anzahl")+
  scale_x_continuous(breaks=seq(0,71,5))+
  scale_color_manual(values= c("blue","red","green"), 
                     name="Legende:", 
                     labels=c("Invalide1","Invalide2","Invalide4")) +
  ggtitle("Markov vs Nicht-Markov")



#Kein Markov-Prozess
f1 <- 1
f2 <- 1
for (j in 0:54) {
  f1 <- c(f1,f1[j+1] * p(x+j)[1,1])
  f2 <- c(f2, pm(1,j+1)[1,1])
}

x <- 1
m <- 54
l_x <- c(1e5, rep(1e5,11))
nmk_a <- 1e5
nmk_i <- 1e5
for (i in 0:m){
  nmk_a <- c(nmk_a, nmk_a[i+1] * p(i+x)[1,1])
}
for (i in 0:m) {
  nmk_i <- c(nmk_i, nmk_i[i+1] * (1-i_xy[[x+i,4]])) 
}

nmk_d <- 1e5 - (nmk_i + nmk_a)
nmk_ges <- rbind(15:(length(nmk_a)+14),nmk_a, nmk_i, nmk_d) 
nmkdata <- data.frame(t(nmk_ges))

#Plott einer normalen Populationsentwicklung

gg <- NULL
gg <- ggplot() + geom_line(data = mkdata, aes(x=V1,y= o,colour= "Aktive(M)"), linetype=2, size =1.1)+
  geom_line(data = mkdata, aes(x=V1,y= V3,colour= "Invalide(M)"), linetype=2, size =1.1)+
  #geom_line(aes(y= X4,colour= "Verstorbene(M)"), linetype=2, size =1.1)+
  geom_line(data = nmkdata, aes(x=V1, y=nmk_a, colour = "Aktive(NM)"),linetype=5, size =1) +
  geom_line(data = nmkdata, aes(x=V1, y=nmk_i, colour = "Invalide(NM)"),linetype=5, size =1) +
  #geom_line(data = hdata, aes(x=V1, y=h_1, colour = "Verstorbene(NM)"),linetype=2, size =1) +
  xlab("Alter")+
  ylab("Anzahl")+
  scale_x_continuous(breaks=seq(0,70,5))+
  scale_color_manual(values= c("blue","darkorange","cyan4","red"), 
                     name="Legende:", 
                     labels=c("Aktive(M)","Aktive(NM)","Invalide(M)","Invalide(NM)")) +
  ggtitle("Markov vs Nicht-Markov")

ggz <- NULL
ggz <- ggplot() + geom_line(data = mkdata, aes(x=V1,y= o,colour= "Aktive(p)"), size =0.5)+
  geom_line(data = mkdata, aes(x=V1,y= V3,colour= "Invalide(p)"), size =0.5)+
  geom_line(data = mk2data, aes(x=V1, y=o, colour = "Aktive(p2)"), size =0.5) +
  geom_line(data = mk2data, aes(x=V1, y=V3, colour = "Invalide(p2)"), size =0.5) +
  geom_line(data = mk4data, aes(x=V1, y=o, colour = "Aktive(p4)"), size =0.5) +
  geom_line(data = mk4data, aes(x=V1, y=V3, colour = "Invalide(p4)"), size =0.5) +
  xlab("Alter")+
  ylab("Anzahl")+
  scale_x_continuous(breaks=seq(0,70,5))+
  scale_color_manual(values= c("blue","yellow", "magenta","cyan2","darkorange2","red"), 
                     name="Legende:", 
                     labels=c("Aktive(p)","Aktive(p2)","Aktive(p4)","Invalide(p)","Invalide(p2)","Invalide(p4)"))







#Plot der Tafeln 
#Inval
ggi <- NULL
ggi <- ggplot() + 
  geom_line(data = i_xy, aes(alter, i_d,col = "Ø"),size = 1) + 
  xlab("Alter") +
  ylab("InvalWS") +
  scale_color_manual(name="Legende:",
                     values= c("black"),
                     breaks =c("Ø"))


#ggqi_diff <- ggplot() + geom_line(data = i_xy, aes(x= alter, y=(i_x-i_y), col="InvalWS")) +
#xlab("Alter") +
#ylab("Differenz Wahrscheinlichkeit")


#SterbeWS
#SterbeWS-Aktiv

ggqa <- NULL
ggqa <- ggplot() + geom_line(data = q_xya, aes(alter, q_d, col = "Ø"),size = 1)+
  xlab("Alter") +
  ylab("SterbeWS") +
  scale_color_manual(name="Legende:",
                     values= c("black"),
                     breaks =c("Ø")) 

#ggqa_diff <- ggqi_diff + geom_line(data = q_xya, aes(x = alter, y= (q_x-q_y), col = "SterbeWS(A)"))

#SterbeWS-Inval
ggqi3 <- NULL
ggqi3 <- ggplot() + geom_line(data = q_xyi, aes(alter, q_ddi, col = "1.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm1di, col = "2.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm2di, col = "3.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm3di, col = "4.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm4di, col = "5.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm5di, col = "6.J"), size = 1) + 
  geom_line(data = q_xyi, aes(alter, q_dm6di, col = "=>6.J"), size = 1) + 
  xlab("Alter") +
  ylab("SterbeWS") +
  scale_color_manual(name="Legende:",
                     values= c(brewer.pal(n = 11, name = "Spectral")[1],brewer.pal(n = 11, name = "Spectral")[3],brewer.pal(n = 11, name = "Spectral")[4],
                               brewer.pal(n = 11, name = "Spectral")[6],brewer.pal(n = 11, name = "Spectral")[8],brewer.pal(n = 11, name = "Spectral")[9],
                               brewer.pal(n = 11, name = "Spectral")[11]),
                     breaks =c("1.J","2.J","3.J","4.J","5.J","=>6.J"))


#Reaktivierung
ggr <- NULL
ggr <- ggplot() + geom_line(data = r_xyi, aes(alter, r_dd, col = "1.J"),size =1) + 
  geom_line(data = r_xyi, aes(alter, r_dm1d, col = "2.J"),size =1) + 
  geom_line(data = r_xyi, aes(alter, r_dm2d, col = "3.J"),size =1) + 
  geom_line(data = r_xyi, aes(alter, r_dm3d, col = "4.J"),size =1) + 
  geom_line(data = r_xyi, aes(alter, r_dm4d, col = "5.J"),size =1) +
  geom_line(data = r_xyi, aes(alter, r_dm5d, col = "6.J"),size =1) +
  geom_line(data = r_xyi, aes(alter, r_dm6d, col = "7.J"),size =1) +
  geom_line(data = r_xyi, aes(alter, r_dm7d, col = "8.J"),size =1) +
  geom_line(data = r_xyi, aes(alter, r_dm8d, col = "9.J"),size =1) + 
  geom_line(data = r_xyi, aes(alter, r_d, col = "=>10.J"),size =1) +
  geom_line(data = r_xyi, aes(alter, r_d, col = "=>6.J"),size =1) +
  xlab("Alter") +
  ylab("ReaktWS") +
  scale_color_manual(name="Legende:",
                     values= c(brewer.pal(n = 11, name = "Spectral")[1],brewer.pal(n = 11, name = "Spectral")[2],brewer.pal(n = 11, name = "Spectral")[3],
                               brewer.pal(n = 11, name = "Spectral")[4],brewer.pal(n = 11, name = "Spectral")[5],brewer.pal(n = 11, name = "Spectral")[6],
                               brewer.pal(n = 11, name = "Spectral")[7],brewer.pal(n = 11, name = "Spectral")[8],brewer.pal(n = 11, name = "Spectral")[9],
                               brewer.pal(n = 11, name = "Spectral")[10],brewer.pal(n = 11, name = "Spectral")[11]),
                     breaks =c("1.J","2.J","3.J","4.J","5.J","6.J","7.J","8.J","9.J","=>10.J","=>6.J"))

#Plott einer  Populationsentwicklung mit 4 zuständen und keiner Reaktivierung ab dem 4 Jahr
y <- rbind(1:(m+1),hm(x,m,1)) 
y_collapsed <- rbind(1:(m+1), y[2,], colSums(y[3:8,]), y[9,])
ydata <- data.frame(t(y_collapsed))
gg4 <- ggplot() + geom_line(data = ydata, col= "red", aes(X1, X2)) + geom_line(data = ydata, col= "blue", aes(X1, X3)) + geom_line(data = ydata, col= "green", aes(X1, X4)) 


gg4 <- ggplot() + geom_line(data = ydata, aes(X1, X2, col = "Aktive"),linetype=2, size =1.1) + 
  geom_line(data = ydata, aes(X1, X3, col = "Invalide"),linetype=2, size =1.1) + 
  geom_line(data = ydata, aes(X1, X4, col = "Verstorbene"),linetype=2, size =1.1) + 
  xlab("Alter") +
  ylab("Population") +
  scale_color_manual("",
                     values= c("green","red","black"),
                     breaks =c("Aktive","Invalide","Verstorbene"))

###############################################################################################
#Barwerte
#ä_x^a
vec <- c(0, rep(1,6),0)
#diskontfaktor
v <- 1/(1+0.0025)
e <- rep(0,8)
#eintrittsalter
x <- 10 
#dauer
l <- 57 - x

#Funktionen zur Prämienberechnung
#Nicht-Markov--------------------------------------------------

aak <- function(x,t){
  a <- 0
  lp <- 100000
  for (i in 1:dim(q_xya)[1]) {
    lp <- c(lp, lp[i]*(1-q_xya[[i,2]]- i_xy[[i,2]]))
  }
  for (i in 0:(t-1)) {
    a <- a + lp[x+i] * v^(x+i)
  }
  a <- a/(lp[x]*v^x)  
  return(a)
}

aik <- function(z,x,l){
  a <- 0
  lp <- 100000
  d <- x-z
  if(l==1){
    a <- 1
    return(a)
  } else if(l==0){
    a <- 0
    return(a)
  }
  if(d >= 5){d <- 5}
  for (i in 0:(l-1)) {
    a <- a + lp * v^(x+i)
    lp <- lp * (1-q_xyi[[x+i,d+2]]- r_xyi[[x+i,d+2]])
  }
  a <- a/(100000*v^x) 
  return(a)
}

aik2 <- function(z,x,l){
  a <- 0
  lp <- 100000
  d <- x-z
  if(l==1){
    a <- 1
    return(a)
  } else if(l==0){
    a <- 0
    return(a)
  }
  if(d >= 5){d <- 5}
  for (i in 0:(l-1)) {
    a <- a + lp * v^(x+i) * (aaik(x+i,10,10)) * r_xyi[[x+i,d+2]]
    lp <- lp * (1-q_xyi[[x+i,d+2]]- r_xyi[[x+i,d+2]]) 
  }
  a <- a/(100000*v^x) 
  return(a)
}
#aik2 <- function(z,x,l){
#  a <- 0
#  lp <- 100000
#  d <- x-z
#  if(l==1){
#    a <- 1
#    return(a)
#  } else if(l==0){
#    a <- 0
#    return(a)
#  }
#  if(d >= 5){d <- 5}
#  for (i in vector) {
#    1 + 
#  }
#  
#  for (i in 0:(l-1)) {
#    a <- a + lp * v^(x+i)
#    lp <- lp * (1-q_xyi[[x+i,d+2]]- r_xyi[[x+i,d+2]])
#  }
#  a <- a/(100000*v^x) 
#  return(a)
#}

aaik <- function(x,n,t){
  a <- 0
  lp <- 100000
  for (i in 0:(n-1)) {
    #print(v^(x+i+0.5)  * lp %*% i_xy[[x+i,2]] *  (1-(0.5*q_xya[[x+i,2]])))
    a <- a + v^(x+i+0.5)  * lp %*% i_xy[[x+i,4]] *  (1-(0.5*q_xya[[x+i,4]])) *  max(0.5 * (aik(x+i,x+i,t-i)+aik(x+i+1,x+i+1,t-i-1))-0.5, 0)
    lp <- lp * (1-q_xya[[x+i,4]]- i_xy[[x+i,4]])
  }
  a <- a/(100000*v^x) 
  return(a)
}

#Funktionen zur Prämienberechnung
#Markov--------------------------------------------------
aa <- function(x,t){
  a <- 1
  e <- c(1,rep(0,11))
  if(t == 1){
    return(a)
  } else{
    for(i in 1:(t-1)){
      a <- a + e %*% pm(x,i) %*%  e * v^i
    }
    return(a)
  }
} 

ai <- function(z,x,l){
  a <- 1
  e <- rep(0,12)
  if(l == 0){
    return(0)
  } 
  if(l == 1){
    return(a)
  } 
  if(x-z < 5){
    e[x-z+2] <- 1 
  } else{
    e[7] <- 1
  }
  for(i in 0:(l-1)){
    a <- a + e %*% pm(x,i) %*%  c(0,rep(1,10),0) * v^i
    }
  return(a)
}


aai <- function(x,n,l){
  a <- 0
  if(l==0){
    return(0)
  }
  if(n==0){
    return(0)
  }
  for (i in 0:(n-1)){
      #print(max(0.5 * (ai(x+i,x+i,t-i)+ai(x+i+1,x+i+1,t-i-1) - 1), 0))
      #print(v^(x+i+0.5)  %*% pm(x,i)[1,1] %*% i_xy[[x+i,2]] *  (1-(0.5*q_xya[[x+i,2]])))
    a <- a + v^(i+0.5)  %*% pm(x,i)[1,1] %*% i_xy[[x+i,4]] *  (1-(0.5*q_xya[[x+i,4]])) *  max((0.5 * (ai(x+i,x+i,l-i)+ai(x+i+1,x+i+1,l-i-1))-0.5), 0)
  }
  return(a)
}

l <- 13
alt <- 36
talph <- 13 #=min(t, t*)
g4 <- 0.015
g1 <- 0.01
g2 <- 0.015  
agam <- 0.01
alph <- 0.04
phi <- 1
bet <- 0.05
axt <- aa(alt,l)
axtn <- aa(alt,l)  
NP <- aai(alt,l,l)/aa(alt,l)

axtk <- aak(alt,l)
axtnk <- aak(alt,l)  
NPk <- aaik(alt,l,l)/aak(alt,l)

  
bprem <- ((1+phi) * (1+g4) * NP * axt + (agam + g1) * axt + g2 * (axtn - axt)) / ((1- bet) * axt - alph * talph)
bpremk <- ((1+phi) * (1+g4) * NPk * axtk + (agam + g1) * axtk + g2 * (axtnk - axtk)) / ((1- bet) * axtk - alph * talph)

#Studie der Barwerte etc.
# verlauf barwerte versch. Eintrittsalter
aailvec <- NULL
for (i in 1:55) {
  aailvec <- c(aailvec,aai(1,i,i))
}
alvec <- rbind(1:length(aailvec),aailvec)
aldata <- data.frame(t(alvec))
aldata2[,2] <- aldata2[,2] / 1.11
aldata2[,1] <- aldata2[,1] +14

aailvec2 <- NULL
for (i in 1:54) {
  aailvec2 <- c(aailvec2,aai(i,2,2))
}
alvec2 <- rbind(1:length(aailvec2),aailvec2)
aldata2 <- data.frame(t(alvec2))
aldata2[52,2] <- aldata2[52,2] - 0.0075
aldata2[,2] <- aldata2[,2] + 14

ggal <- NULL
ggal <- ggplot() + 
  geom_point(data = aldata, aes(V1,aailvec,col = "Anwartschaft")) +
  scale_colour_manual("Legende:",breaks = c("Anwartschaft"),values = c("black")) +
  xlab("Versicherungsdauer") +
  ylab("Barwert") +
  scale_x_continuous(breaks = seq(0,60,by=10))+
  scale_y_continuous(breaks = seq(0,5, by=.5)) 

ggal2 <- NULL
ggal2 <- ggplot() + 
  geom_point(data = aldata2, aes(V1,aailvec2,col = "Anwartschaft")) +
  scale_colour_manual("Legende:",breaks = c("Anwartschaft"),values = c("black")) +
  xlab("Eintrittsalter") +
  ylab("Barwert") +
  scale_x_continuous(breaks = seq(0,70,by=10))+
  scale_y_continuous(breaks = seq(0,0.15, by=.01)) 


#verlauf Leistungsbarwert
aivec <- NULL
for (i in 1:55) {
  aivec <- c(aivec,ai(i,i,57-i))
}


aavec <- NULL
for (i in 1:55) {
  aavec <- c(aavec, aa(i,57-i))
}
avec <- rbind(15:(length(aavec)+14),aavec, aivec)
adata <- data.frame(t(avec))

ggrp <- ggplot() + geom_point(data = airpdata,col = "black", aes(V1,aivec))

#Plot Barwert Anwartschaft vs.Leistungsphase
gga <- NULL
gga <- ggplot() + 
  geom_point(data = adata, aes(V1,aavec,col = "Anwartschaft")) + 
  geom_point(data = adata, aes(V1,aivec,col = "Leistungsphase")) + 
  scale_colour_manual("Legende:",breaks = c("Anwartschaft","Leistungsphase"),values = c("black","red")) +
  xlab("Alter") +
  ylab("Barwert") +
  ggtitle("Barwert Anwartschaft/Leistungsphase") +
  scale_x_continuous(breaks = seq(0,70,by=10))+
  scale_y_continuous(breaks = seq(0,30, by=5)) 


#run oldT first and then new script in order to make it work 
aaidata_old <- aaidata
nettopdata_old <- nettopdata

#Nettoeinmalprämie Merkov(aaivec) vs. Nicht-Markov(aaikvec)
aaivec <- NULL
for (i in 1:55) {
  aaivec <- c(aaivec,aai(i,56-i,56-i))
}

aaikvec <- NULL
for (i in 1:55) {
  aaikvec <- c(aaikvec,aaik(i,56-i,56-i))
}

aaiavec <- rbind(15:(length(aaivec)+14),aaivec, aaikvec)
aaidata <- data.frame(t(aaiavec))

#Plot Barwert aai vs. aaik (Nettoeinmalprämie Markov/Nicht-Markov)
ggnep <- ggplot() + 
  geom_point(data = aaidata, aes(V1,aaivec, colour = "NEP-M(2021)")) + 
  geom_point(data = aaidata, aes(V1,aaikvec, colour = "NEP-NM(2021)")) + 
  #geom_point(data = aaidata_old, aes(V1,aaivec, colour = "NEP-M(1997)"),shape = 23) + 
  #geom_point(data = aaidata_old, aes(V1,aaikvec, colour = "NEP-NM(1997)"),shape = 23) + 
  scale_colour_manual("",breaks = c("NEP-M(2021)","NEP-NM(2021)","NEP-M(1997)","NEP-NM(1997)"),values = c("black","red","black","red")) +
  xlab("Eintrittsalter") +
  ylab("Barwert") +
  scale_x_continuous(breaks = seq(0,80,by=10))+
  scale_y_continuous(breaks = seq(0,4.5, by=0.5))

datadiff <- 
ggnepapa <- ggplot() + 
  geom_point(data = datadiff)

#Prämienbarwert zur Berechnung der Netto(jahres)prämie Markov(NP) vs.  Nicht-Markov(NPk)
aavec <- NULL 
for (i in 1:55) {
  aavec <- cbind(aavec,rbind(1,aa(i,56-i), aak(i,56-i)))
}

#Nettojahresprämie
nettop <- aaiavec / aavec
nettopdata <- data.frame(t(nettop))

#Plot 
#Nettojahresprämie Markov/Nicht-Markov
ggnettop <- ggplot() + 
  geom_point(data = nettopdata, aes(V1,aaivec, colour = "NP-M(2021)")) + 
  geom_point(data = nettopdata, aes(V1,aaikvec, colour = "NP-NM(2021)")) + 
  scale_colour_manual("",breaks = c("NP-M(2021)","NP-NM(2021)"),values = c("black","red")) +
  xlab("Eintrittsalter") +
  ylab("Barwert") +
  scale_x_continuous(breaks = seq(0,80,by=10))+
  scale_y_continuous(breaks = seq(0,0.3, by=0.05))



#Vergleich NEP und NP 1997 vs 2021
diffnep <- na.omit(aaidata_old / aaidata)
diffnp <- na.omit(nettopdata_old / nettopdata)
diffnp <- 1/diffnp
diffnep <- 1/diffnep

diffnep[,1] <- 15:68
diffnp[,1] <- 15:68

#Quotient NEP 1997/2021
ggdiffnep <- ggplot() + 
  geom_point(data = diffnep, aes(V1,aaivec, colour = "NEP-M")) + 
  geom_point(data = diffnep, aes(V1,aaikvec, colour = "NEP-NM")) + 
  scale_colour_manual("",breaks = c("NEP-M","NEP-NM"),values = c("black","red")) +
  xlab("Eintrittsalter") +
  ylab("Quotient Barwert") +
  scale_x_continuous(breaks = seq(0,80,by=10))+
  scale_y_continuous(breaks = seq(0,1, by=0.1))

#Quotient NP 1997/2021
ggdiffnp <- ggplot() + 
  geom_point(data = diffnp, aes(V1,aaivec, colour = "NP-M")) + 
  geom_point(data = diffnp, aes(V1,aaikvec, colour = "NP-NM")) + 
  scale_colour_manual("",breaks = c("NP-M","NP-NM"),values = c("black","red")) +
  xlab("Eintrittsalter") +
  ylab("Quotient Barwert") +
  scale_x_continuous(breaks = seq(0,80,by=10))+
  scale_y_continuous(breaks = seq(0,1, by=0.1))




#Premienrechnung mit Rekursionsgleichung aus DAVR 2021

aik2 <- function(z,x,l){
  lp <- 100000
  a <- 0
  d <- x-z
  if(l==1){
    a <- 1
    return(a)
  } else if(l==0){
    a <- 0
    return(a)
  }
  if(d >= 5){d <- 5}
  for (i in 0:(l-1)) {
    a <- a + lp * r_xyi[[x+i+1,d+2]] * v^(x+1+i)*(aaik(x+i,l-i,l-i)-0.05*aak(x+i,l-i)) 
    lp <-  lp * (1-q_xyi[[x+i,d+2]]- r_xyi[[x+i,d+2]])
  }
  a <- a/(100000*v^x) 
  return(a)
}

lbw1 <- NULL
for (m in 1:40) {
  lbw1 <- c(lbw1, aik2(m,m,53-m))
  print("-")
}

lbw2 <- NULL
for (m in 1:40) {
  lbw2 <- c(lbw2, aik(m,m,53-m))
  print("-")
}

lbw3 <- NULL
for (m in 1:40) {
  lbw3 <- c(lbw3, ai(m,m,53-m))
  print("-")
}
lbw11 <- c(2.8221708, 2.7841547, 2.7449936, 2.7046935, 2.6633414, 2.6205128, 2.5766157, 2.5313286, 2.4843911, 2.4355323, 2.3842324, 2.3300542, 2.2724351, 2.2114052,
2.1470942, 2.0775371, 2.0016723, 1.9216233, 1.8391160, 1.7544050, 1.6673358, 1.5780149, 1.4870496, 1.3951101, 1.3026155, 1.2099276, 1.1173481, 1.0249678,
0.9333134, 0.8426992, 0.7535736, 0.6668167, 0.5836178, 0.5046276, 0.4304523, 0.3617259, 0.2990578, 0.2430587, 0.1940825, 0.1519215)

 ggabsch <- NULL
 ggabsch <- ggplot() + 
   geom_point(data = data.frame(lbw1), aes(V1,aaivec, colour = "NP-M")) + 
   geom_point(data = diffnp, aes(V1,aaikvec, colour = "NP-NM")) + 
   scale_colour_manual("",breaks = c("NP-M","NP-NM"),values = c("black","red")) +
   xlab("Eintrittsalter") +
   ylab("Quotient Barwert") +
   scale_x_continuous(breaks = seq(0,80,by=10))+
   scale_y_continuous(breaks = seq(0,1, by=0.1)) 
 
#########################
diffbonus <- NULL
diffbonus <- (rbind(15:(length(nettop[1,])+14),((nettop[2,]/nettop[3,])-1)*100, ((aaiavec[2,]/aaiavec[3,])-1)*100))
diffbonus[is.nan(diffbonus)] <- 0
diffbondata <- data.frame(t(diffbonus))

#Plot 
ggdiffbon <- ggplot() + 
  geom_point(data = diffbondata, aes(X1,X2, colour = "NPdiff")) + 
  geom_point(data = diffbondata, aes(X1,X3, colour = "NEPdiff")) + 
  scale_colour_manual("",breaks = c("NPdiff","NEPdiff"),values = c("black","red")) +
  xlab("Alter") +
  ylab("diff(%)") +
  ggtitle("Prämien-Differenz Markov/Nicht-Markov") +
  scale_x_continuous(breaks = seq(0,80,by=10))+
  scale_y_continuous(breaks = seq(0,50, by=10))

#verlauf nettodeckungskapital
vmxfunc <- function(x,n,l,m){
    vmx <- aai(x+m,n-m,l-m) - ((aai(x,n,l)/aa(x,n)) *aa(x+m,n-m))
    return(c(m,vmx))
}

vma <- c(0,0)
for (i in 1:20) {
  vma <- rbind(vma,vmxfunc(25,25,25,i))
}

vmadata <- data.frame(vma)
ggvma <- ggplot() + geom_point(data = vmadata, aes(X1,X2, colour ="Anwartschaft"))+ labs(y = expression(mVx), x = "m") + scale_colour_manual("",
                                                                                                         breaks = c("Anwartschaft"),
                                                                                                         values = c("black"))

vmi <- NULL
for (i in 15:20){
  vmi <- rbind(vmi, c(i,ai(40,25+i,25-i)))
}
vmidata <- data.frame(vmi)

ggvm <- ggvma + geom_point(data = vmidata, aes(X1,X2, colour ="Leistungsphase")) +
scale_colour_manual("", 
                    breaks = c("Anwartschaft", "Leistungsphase"),
                    values = c("black", "red"))

#plot
q <- NULL
for (j in 1:55){
  q <- c(q,axxl(j,56-j))
}
qdata <- data.frame(cbind(q, 1:length(q)))
ggl <- ggplot() + geom_line(data = qdata, col = "black", aes(V2, q))
#
#
#aai <- function(x,l){
#  t <- 1
#  for(j in 1:l-1){
#    print(axxl(x+j,l-j))
#    print(axxl(x+j+1,l-j-1))
#    print(x+j)
#    print(l-j)
#    t <- t + pm(x,j)[1,1] * (1/(1+0.02))^(j+0.5) * i_xy[[x+j,2]] * (1-(0.5*q_xya[[x+j,2]])) * max(0.5 * (axxl(x+j,l-j)+axxl(x+j+1,l-j-1))-1, 0)
#  }
#  return(t)
#}

